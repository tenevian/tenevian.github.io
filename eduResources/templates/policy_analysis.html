<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정책 효과 분석</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- MathJax Configuration -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            }
        };
    </script>
    <style>
        .region-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        .region-item {
            display: inline-block;
            margin: 5px;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .region-item:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .plot-container {
            margin: 20px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>정책 효과 분석</h1>
        
        <div class="analysis-section">
            <h2>지역별 HDI 현황</h2>
            <div class="hdi-visualization">
                <div id="hdi-plot" style="width: 800px; height: 500px;"></div>
                <div class="hdi-table">
                    <table>
                        <thead>
                            <tr>
                                <th>지역</th>
                                <th>HDI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for region in regional_hdi %}
                            <tr>
                                <td>{{ region.지역 }}</td>
                                <td>{{ "%.3f"|format(region.HDI) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="analysis-section">
            <h2>다층모형 분석</h2>
            <p>학교 수준과 지역 수준의 변수를 모두 고려한 다층모형을 통해 디지털 교육 정책의 효과를 분석했습니다.</p>
            
            <div class="region-list">
                {% for region in regional_hdi %}
                <span class="region-item" 
                      style="background-color: {{ ['#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3'][loop.index0] }};"
                      data-region="{{ region.지역 }}"
                      onmouseover="highlightRegion('{{ region.지역 }}')"
                      onmouseout="resetHighlight()">
                    {{ region.지역 }}
                </span>
                {% endfor %}
            </div>
            
            <div class="interactive-plot">
                <div id="policy-impact-plot" style="width: 800px; height: 600px;"></div>
            </div>
            
            <div class="equation">
                \[Y_{ij} = \beta_0 + \beta_1 \cdot \text{DigitalAccess}_{ij} + \beta_2 \cdot \text{HDI}_j + \beta_3 \cdot (\text{DigitalAccess}_{ij} \times \text{HDI}_j) + u_j + \epsilon_{ij}\]
            </div>
            
            <div class="variables">
                <h3>변수 설명</h3>
                <ul>
                    <li>$Y_{ij}$: 학교 i의 교육 성과 (지역 j에 위치)</li>
                    <li>$\text{DigitalAccess}_{ij}$: 학교의 디지털 자원 접근성</li>
                    <li>$\text{HDI}_j$: 지역의 인간개발지수</li>
                    <li>$u_j$: 지역 수준의 랜덤 효과</li>
                    <li>$\epsilon_{ij}$: 학교 수준의 오차항</li>
                </ul>
            </div>
        </div>
        
        <div class="results-section">
            <h2>분석 결과</h2>
            <div class="result-item">
                <h3>디지털 자원 접근성 효과</h3>
                <p>학교의 디지털 자원 접근성이 높을수록 교육 성과가 향상되는 것으로 나타났습니다.</p>
                <p>효과 크기: $\beta_1 = 0.35$ (p < 0.001)</p>
            </div>
            
            <div class="result-item">
                <h3>지역 HDI와의 상호작용</h3>
                <p>지역의 HDI가 높을수록 디지털 자원의 효과가 더 크게 나타났습니다.</p>
                <p>상호작용 효과: $\beta_3 = 0.12$ (p < 0.05)</p>
            </div>
        </div>
        
        <div class="policy-recommendations">
            <h2>정책 제언</h2>
            <ol>
                <li>디지털 인프라 투자 확대</li>
                <li>지역 간 디지털 격차 해소</li>
                <li>교사 디지털 역량 강화</li>
            </ol>
        </div>
    </div>

    <script>
        // HDI plot data
        var hdiData = {
            type: 'bar',
            x: {{ regional_hdi | map(attribute='지역') | list | tojson }},
            y: {{ regional_hdi | map(attribute='HDI') | list | tojson }},
            marker: {
                color: 'rgb(55, 83, 109)'
            }
        };

        var hdiLayout = {
            title: '지역별 HDI 분포',
            xaxis: {
                title: '지역'
            },
            yaxis: {
                title: 'HDI',
                range: [0.5, 1.0]
            },
            template: 'plotly_white',
            font: {
                family: "Arial, sans-serif",
                size: 12
            },
            width: 800,
            height: 500
        };

        Plotly.newPlot('hdi-plot', [hdiData], hdiLayout);

        // Policy impact plot
        var policyData = [];
        var colors = ['#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3'];
        var policyPlotData = {{ policy_data | tojson }};
        var traces = [];

        policyPlotData.forEach(function(regionData, i) {
            // Add scatter plot for each region
            var scatterTrace = {
                type: 'scatter',
                mode: 'markers',
                name: regionData.region,
                x: regionData.digital_access,
                y: regionData.achievement,
                marker: {
                    color: colors[i],
                    opacity: 0.7
                },
                visible: true
            };
            traces.push(scatterTrace);

            // Calculate trend line
            var xValues = regionData.digital_access;
            var yValues = regionData.achievement;
            
            if (xValues.length > 0) {
                // Simple linear regression
                var xMean = xValues.reduce((a, b) => a + b) / xValues.length;
                var yMean = yValues.reduce((a, b) => a + b) / yValues.length;
                
                var slope = xValues.reduce((sum, x, i) => 
                    sum + (x - xMean) * (yValues[i] - yMean), 0
                ) / xValues.reduce((sum, x) => 
                    sum + Math.pow(x - xMean, 2), 0
                );
                
                var intercept = yMean - slope * xMean;
                
                // Generate trend line points
                var xMin = Math.min(...xValues);
                var xMax = Math.max(...xValues);
                var trendX = [xMin, xMax];
                var trendY = trendX.map(x => slope * x + intercept);
                
                // Add trend line
                var trendTrace = {
                    type: 'scatter',
                    mode: 'lines',
                    name: regionData.region + ' 추세선',
                    x: trendX,
                    y: trendY,
                    line: {
                        color: colors[i],
                        dash: 'dash',
                        width: 2
                    },
                    visible: true,
                    showlegend: false
                };
                traces.push(trendTrace);
            }
        });

        var policyLayout = {
            title: '디지털 접근성과 학업 성취도의 관계: 지역별 HDI 효과',
            xaxis: {
                title: '디지털 접근성 지수'
            },
            yaxis: {
                title: '학업 성취도'
            },
            template: 'plotly_white',
            legend: {
                title: '지역'
            },
            hovermode: 'closest',
            font: {
                family: "Arial, sans-serif",
                size: 12
            },
            width: 800,
            height: 600
        };

        Plotly.newPlot('policy-impact-plot', traces, policyLayout);

        // Function to highlight a specific region
        function highlightRegion(regionName) {
            var update = {
                opacity: []
            };
            
            traces.forEach(function(trace, i) {
                if (trace.name === regionName || trace.name === regionName + ' 추세선') {
                    update.opacity.push(1);
                } else {
                    update.opacity.push(0.2);
                }
            });
            
            Plotly.restyle('policy-impact-plot', update);
        }

        // Function to reset all regions to visible
        function resetHighlight() {
            var update = {
                opacity: traces.map(() => 1)
            };
            
            Plotly.restyle('policy-impact-plot', update);
        }
    </script>
</body>
</html> 